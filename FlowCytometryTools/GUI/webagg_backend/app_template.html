<html>
<head>
    <!-- matplotlib's -->
    <link rel="stylesheet" href="_static/css/page.css" type="text/css">
    <link rel="stylesheet" href="_static/css/boilerplate.css" type="text/css"/>
    <link rel="stylesheet" href="_static/css/fbm.css" type="text/css"/>
    <script src="mpl.js"></script>

    <!-- static jquery and jquery ui -->
    <!-- <script src="_static/jquery/js/jquery-1.7.1.min.js"></script> -->
    <!-- <script src="_static/jquery/js/jquery.min.js"></script> -->
    <!-- <script src="_static/jquery/js/jquery-ui.min.js"></script> -->

    <!-- JQuery -->
    <!-- <script src="//code.jquery.com/jquery-2.1.3.min.js"></script> -->
    <script src="//code.jquery.com/jquery-2.1.3.min.js"></script>

    <!-- JQuery UI -->

    <script src="//code.jquery.com/ui/1.11.3/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.11.3/themes/black-tie/jquery-ui.css">

    <!-- Latest compiled and minified JavaScript -->
    <!-- bootstrap yeti theme -->

    <!-- BOOT STRAP -->
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootswatch/3.3.2/spacelab/bootstrap.min.css">

    <style>
        #toolbar {
            <!--position: absolute;-->
            width: 100%%;
            left: 0;
            text-align: center;
        }
        /* support: IE7 */
        *+html #toolbar {
        display: inline;
        }

        #figure {
        display:inline-block;
        border:2px solid black;
        }

        #workspace {
            overflow:auto;
            max-height:100%%;
            height:100%%;
            display:block;
        }

        #channel-selection-menu {
            display: inline;
            left:20%%;
            top:20%%;
            position: absolute;
            z-index: 9999; // pop-up
            width: auto;
        }
    </style>

    <script>

      function ondownload(figure, format) {
        window.open('download.' + format, '_blank');
      };

      $(document).ready(
        function() {
          var websocket_type = mpl.get_websocket_type();
          var websocket = new websocket_type("%(ws_uri)sws");

          // mpl.figure creates a new figure on the webpage.
          var fig = new mpl.figure(
              // A unique numeric identifier for the figure
              %(fig_id)s,
              // A websocket object (or something that behaves like one)
              websocket,
              // A function called when a file type is selected for download
              ondownload,
              // The HTML element in which to place the figure
              $('div#figure'));

            // Initialize the controls.
            var send_message = function(type, properties) {
                properties['type'] = type;
                websocket.send(JSON.stringify(properties));
            }

            // Initialize GUI elements
            initialize_ui(fig, send_message);
            initialize_toolbar(send_message);
        }
      );

    var initialize_ui = function(fig, send_message) {
        var menu = $('#channel-selection-menu');
        menu.menu();

        fig.handle_axis_click = function(fig, msg) {
            menu.css('left', fig.last_mouse_event.pageX);
            menu.css('top', fig.last_mouse_event.pageY);
            create_selection_menu(menu, msg['options'],
             function (value) {
                msg['name'] = 'change_axis';
                msg['value'] = value;
                send_message('app_control', msg);
             }
            );
        }

        $("#figure").draggable({containment: "#workspace"});
        $("#figure").position({of: $(window)});

        // Add buttons to figure
        /*
        var button = $('<button/>');

        button.addClass('ui-button ui-widget ui-state-default ui-corner-all ' +
                        'ui-button-icon-only');
        button.click(function () {alert('hello');});

        var icon_img = $('<span/>');
        icon_img.addClass('ui-button-icon-primary ui-icon');
        icon_img.addClass('ui-icon ui-icon-home');
        icon_img.addClass('ui-corner-all');
        button.append(icon_img);
        var nav_element = $('#figure').children('div').last().children('div').last();
        nav_element.append(button);
        */

    }

    var initialize_toolbar = function(send_message) {
        var button_message_mapping = [ 'open_file',
                'draw_poly_gate',
                'draw_poly_gate',
                'draw_vertical_gate',
                'draw_horizontal_gate',
                'delete_gate'];

        $.each(button_message_mapping, function (index, value) {
            button_id = '#app_' + value;
            $(button_id).click(function () {
                send_message('app_control', {name: value});
            });
        });

        $("#toolbar").find("button")
            .addClass("btn btn-default navbar-btn btn-primary");
    }

    var create_selection_menu = function (menu, options, callback) {
        menu.empty(); // Remove children

        function add_menu_item(item) {
            menu.append('<li>' + item + '</li>');
        }

        function item_clicked() {
            callback(this.innerHTML);
            menu.hide();
        }

        $.each(options, function (index, value) {
                add_menu_item(value);
                });

        menu.children('li').click(item_clicked);

        menu.show();
        menu.menu("refresh");
    }

    </script>
    <title>matplotlib</title>
</head>

<body>

<nav class="navbar navbar-default navbar-static-top" role="navigation">
    <div class="container">
        <ul class="nav navbar-nav navbar-left">
            <li><a href="#">Flow Cytometry Tools</a></li>
        </ul>
        <div id="toolbar">
            <div class="btn-group btn-group-xg">
                <!--<button id="open_file" title="Load an FCS file"><span class="glyphicon glyphicon-cloud-upload"></span>-->
                <!--</button>-->
                <button id="app_draw_poly_gate"><span class="glyphicon glyphicon-star-empty"></span></button>
                <button id="app_draw_vertical_gate"><span class="glyphicon glyphicon-resize-vertical"></span></button>
                <button id="app_draw_horizontal_gate"><span class="glyphicon glyphicon-resize-horizontal"></span></button>
                <button id="app_delete_gate"><span class="glyphicon glyphicon-trash"></span></button>
            </div>
        </div>
    </div>
</nav>

<div id="workspace">
    <div id="figure">
    </div>

    <div>
        <ul id="channel-selection-menu">
        </ul>
    </div>
</div>

</body>
</html>
